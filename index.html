<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión Heladería</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; padding: 10px; margin: 0; }
    h1, h2 { margin: 10px 0; text-align: center; }
    section { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background: #eee; }
    input, select, button { margin: 4px 0; padding: 6px; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; }
    .flex-container { display: flex; gap: 10px; flex-wrap: wrap; }
    .flex-container > * { flex: 1 1 100px; }
    nav a { margin: 0 10px; color: #007BFF; text-decoration: none; font-weight: bold; }
    nav a:hover { text-decoration: underline; }

    /* Colores de helados de agua */
    .agua-verde { background-color: #c8f7c5; }
    .agua-rosa { background-color: #f7c8d1; }
    .agua-amarillo { background-color: #f7f1c8; }

    @media(max-width: 600px){
      table, thead, tbody, th, td, tr { display: block; }
      tr { margin-bottom: 10px; border-bottom: 2px solid #eee; }
      td { text-align: right; padding-left: 50%; position: relative; }
      td::before { 
        content: attr(data-label); 
        position: absolute; left: 10px; width: 45%; text-align: left; font-weight: bold;
      }
      th { display: none; }
    }
  </style>
</head>
<body>
  <h1>🍦 Gestión de Heladería</h1>

  <nav>
    <a href="#productos">Ir a Productos</a>
    <a href="#venta">Registrar Venta</a>
    <a href="#ventas">Ver Ventas</a>
  </nav>

  <section id="productos">
    <h2>Productos</h2>
    <input type="text" id="buscador" placeholder="Buscar producto..." onkeyup="filtrarProductos()">
    <table id="tablaProductos">
      <thead>
        <tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="venta">
    <h2>Registrar venta</h2>
    <div class="flex-container">
      <select id="ventaProducto"></select>
      <input id="ventaCantidad" type="number" min="1" value="1">
      <button onclick="registrarVenta()">Vender</button>
    </div>
  </section>

  <section id="ventas">
    <h2>Ventas</h2>
    <p id="resumen"></p>
    <table id="tablaVentas">
      <thead>
        <tr><th>ID</th><th>Fecha</th><th>Producto</th><th>Cant.</th><th>Total</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD9XWBiMWR6M2b-h_1g6VP_89_L6NQjiU0",
    authDomain: "heladeria-stock.firebaseapp.com",
    databaseURL: "https://heladeria-stock-default-rtdb.firebaseio.com/",
    projectId: "heladeria-stock",
    storageBucket: "heladeria-stock.appspot.com",
    messagingSenderId: "1044455774467",
    appId: "1:1044455774467:web:505435d32bcf1eb0ffb136"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Productos con stock inicial correcto
  const productosBase = [
    {id:1, nombre:"Agua (Verde)", precio:200, stock:36, clase:"agua-verde"},
    {id:2, nombre:"Agua (Rosa)", precio:200, stock:36, clase:"agua-rosa"},
    {id:3, nombre:"Agua (Amarillo)", precio:200, stock:36, clase:"agua-amarillo"},
    {id:4, nombre:"Crema", precio:300, stock:30, clase:""},
    {id:5, nombre:"Bonbom", precio:700, stock:24, clase:""},
    {id:6, nombre:"Bonbom Crocante", precio:800, stock:24, clase:""},
    {id:7, nombre:"Pote", precio:2000, stock:12, clase:""},
    {id:8, nombre:"Cono", precio:2000, stock:12, clase:""}
  ];

  let productosCache = {};

  // Escuchar productos y crear si está vacío
  onValue(ref(db,"productos"), (snapshot)=>{
    if(!snapshot.exists()){
      productosBase.forEach(p => set(ref(db,"productos/"+p.id), p));
      productosCache = {};
    } else {
      productosCache = snapshot.val();
    }
    renderProductos(document.getElementById("buscador").value, productosCache);
  });

  function renderProductos(filtro = "", data={}){
    const tbody = document.querySelector("#tablaProductos tbody");
    tbody.innerHTML="";
    Object.values(data)
      .filter(p => p.nombre.toLowerCase().includes(filtro.toLowerCase()))
      .forEach(p=>{
        const clase = p.clase ? `class="${p.clase}"` : "";
        tbody.innerHTML += `<tr ${clase}>
          <td data-label="ID">${p.id}</td>
          <td data-label="Nombre">${p.nombre}</td>
          <td data-label="Precio">$${p.precio}</td>
          <td data-label="Stock">${p.stock}</td>
          <td data-label="Acciones">
            <button onclick="ajustarStock(${p.id},1)">+1</button>
            <button onclick="ajustarStock(${p.id},-1)">-1</button>
          </td>
        </tr>`;
      });

    const sel = document.getElementById("ventaProducto");
    sel.innerHTML="<option value=''>-- elegir --</option>";
    Object.values(data).forEach(p=>{
      sel.innerHTML += `<option value='${p.id}'>${p.nombre} (stock ${p.stock}) - $${p.precio}</option>`;
    });
  }

  window.ajustarStock = (id, delta)=>{
    const prodRef = ref(db,"productos/"+id);
    get(prodRef).then(snap=>{
      if(snap.exists()){
        const prod = snap.val();
        update(prodRef,{stock: Math.max(0,prod.stock+delta)});
      }
    });
  };

  onValue(ref(db,"ventas"), (snapshot)=>{
    const ventas = snapshot.exists()? Object.values(snapshot.val()) : [];
    renderVentas(ventas);
  });

  function renderVentas(ventas){
    const tbody = document.querySelector("#tablaVentas tbody");
    tbody.innerHTML="";
    let total=0, items=0;
    ventas.forEach(v=>{
      total+=v.total; items+=v.cantidad;
      tbody.innerHTML+=`<tr>
        <td data-label="ID">${v.id}</td>
        <td data-label="Fecha">${new Date(v.fecha).toLocaleString()}</td>
        <td data-label="Producto">${v.producto}</td>
        <td data-label="Cantidad">${v.cantidad}</td>
        <td data-label="Total">$${v.total}</td>
        <td data-label="Acciones"><button onclick="eliminarVenta(${v.id})">Eliminar</button></td>
      </tr>`;
    });
    document.getElementById("resumen").innerText=`Ventas: ${ventas.length} | Ítems: ${items} | Total: $${total}`;
  }

  window.registrarVenta = ()=>{
    const pid = parseInt(document.getElementById("ventaProducto").value);
    const cantidad = parseInt(document.getElementById("ventaCantidad").value);
    if(!pid || cantidad<=0) return alert("Datos inválidos");
    const prod = productosCache[pid];
    if(!prod || prod.stock<cantidad) return alert("No hay stock suficiente");

    const id = Date.now();
    const total = prod.precio*cantidad;
    const venta = {id, producto: prod.nombre, cantidad, total, fecha: new Date().toISOString()};
    set(ref(db,"ventas/"+id), venta);
    update(ref(db,"productos/"+pid), {stock: prod.stock-cantidad});
  };

  window.eliminarVenta = (id)=>{
    get(ref(db,"ventas/"+id)).then(snap=>{
      if(snap.exists() && confirm("¿Eliminar venta?")){
        const v = snap.val();
        Object.values(productosCache).forEach(p=>{
          if(p.nombre === v.producto) update(ref(db,"productos/"+p.id), {stock: p.stock+v.cantidad});
        });
        remove(ref(db,"ventas/"+id));
      }
    });
  };

  window.filtrarProductos = ()=> renderProductos(document.getElementById("buscador").value, productosCache);
</script>
</body>
</html>
